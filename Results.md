
## 1. Сбор и предобработка данных. ##

### Данные ChEMBL  для обучающей и тестовой выборки. ###

| № Этапа    | Название               | Количество соединений |
| ------------- |:------------------:| -----:|
| 1    | Скачивание всех активностей в IC50   | 13200|
| 2     | Исключение активностей по отношению к мутантным формам hERG |	13181 |
| 3  | Исключение дубликатов (по ChEMBL_ID) и удаление строк с путыми значениями в колонках units, standard_type, value  | 8253 |
| 4  | Приведение всех значений IC50 к одним единицам измерения (nM)  | 8253 |
| 5  | Проставление меток класса (граница IC50 = 10 мкМ)| 8253 |
| 6  | Исключение соединений с пропущенными или неопределенными значениями в realtion  | 8158 |
| 7  | Расчет pIC50  | 8158 |
| 8  |  	Стандартизация RDkit | 8158 |
| 9  |  	Исключение солевых форм |	7879 |

### Обработка данных для валидационного сета из независимых данных hERG-central. ###

| № Этапа    | Название               | Количество соединений |
| ------------- |:------------------:| -----:|
| 1    | Скачивание всех активностей в % ингибирования при концентрациях 1 и 10 мкМ   | 306895 |
| 2  | Исключение дубликатов (по PubChem_ID) и удаление строк с путыми значениями  | 306895 |
| 3  | Проставление меток класса (граница IC50 = 10 мкМ)| 306895 |
| 4  |  	Исключение солевых форм |	294939 |

Далее была проведена кластеризация соединений с помощью пакета KNN от PatWalter (https://github.com/PatWalters/kmeans) на 500 кластеров. С параметрами: fp = morgan3, dim = 2048, samples = 6000: 

![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/clustering.JPG)

Как видно на гистограмме, кластер под номером 226 оказался наиболее многочисленным по числу соединений. Однако структры, входящие в него также довольно разнородны.
При попытке составить валидационный сет из первого представителя каждого кластера, выборка оказалась сильно несбалансированной (на 497 соединений только одно активное в отношении hERG). При этом 225 активных соединений из ~300 тысяч соединений были разбиты на 72 разных кластера, в то время как оставшиеся 294714 неактивных соединений распределялись между 496 кластерами. Таким образом, для достижения наиболее репрезентативного валидационного сета, было отобрано 72 первых активных соединений из разных кластеров + 496 первых неактивных соединений из разных кластеров. Суммарно получили валидационную выборку из 568 соединений. 

## 2. Анализ датасета. ##
  - Статистический анализ по целевому значению переменной (IC50).
 ![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/df_stat.JPG)    ![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/train_stat.JPG)
 ![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/test_stat.JPG)
  - Анализ на схожесть (similarity-анализ) обучающей и тестовой выборок. Similarity-анализ был для двух выорок реализован следующим образом:
  1. Расчет Tanimoto_matrix (где в узлах матрицы расположены значения Tanimoto index между каждым соединением из выборки №1 с каждым соединением из выборки №2).
  2. Подсчет количества сходных соединений в различных диапазонах Tanimoto_index (0-0.33, 0.33-0.66, 0.66-1.00).
  3. Построение графика распределения по парным значениям Tanimoto_index.
  Для similarity-анализа двух выборок обучающей и тестовой (train и test):
  
  Counter({'Tanimoto_index = 0.66 - 1.00': 1056, 'Tanimoto_index = 0.33 - 0.66': 419, 'Tanimoto_index = 0.00 - 0.33': 101})
  
  Таким образом, 1056 соединений из обучающей выборки явлюятся хорошо похожими на таковые соединения из тестовой выборки, и лишь 101 соединения совсем не похожи друг на друга. Следовательно, построенная модель будет верно предсказывать тестовую выборку, деление на обучающие и тестовые наборы прошло успешно. 
  ![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/test-train-sim-matrix.JPG)
  На графике наглядно видно, что около 100 соединений лежат в точке Tanimoto-index == 1.0. Это означает, что в трэйновой и тестовой выборке есть одинаковые соединения. Данный факт потребовал изучения, поскольку все дубликаты соединений были удалены на этапе сбора, предобработки и подготовки данных.
  
  Визуально было замечено, что эти соединения - стереоизомеры. Причем 15/108 таких соединений показывали различную активность по отношению к каналам hERG. 
  Соединения-стереоизомеры из обучающей выборки с различной IC50:
  ![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/pairs_stereoisomers_diff_train.JPG)
  Соединения-стереоизомеры из тестовой выборки с различной IC50:
  ![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/pairs_stereoisom_diff_test.JPG)
  Была реализована функция, которая считает число стереоизомеров с одинаковым классом и число стереоизомеров с разным классом активности. Для всех стереоизомеров с разными классами функция находит среднюю разницу в активности в nM. 
  - Number of compounds with the same IC50 class = 93
  - Number of compound with the different IC50 class = 15
  - Mean of difference in IC50 nM = 35881.505

Так как значение 36 мкМ превышает установленный нами предел для определения класса активности, то было решено удалить из обучающей выборки такие соединения. 
Таким образом, была проведена оценка возможного влияния стереоизомеров на результаты работы модели.

Наиболее важным этапом similarity анализа также является сравнение выборок внутри себя. Это позволит выявить, насколько разнообразны соединения в каждом наборе. 
Для train-train matrix получаем следующие значения: 
![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/train-train_matrix.JPG)

Counter({'Tanimoto_index = 0.66 - 1.00': 4279, 'Tanimoto_index = 0.33 - 0.66': 1590, 'Tanimoto_index = 0.00 - 0.33': 434}), 

4279 из 6303 (~70%) соединений довольно схожи друг с другом. Это означает, что мы можем столкнуться с проблемой, когда модель научится предсказывать только данный "кластер" соединений...

![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/test-test_matrix.JPG)

Counter({'Tanimoto_index = 0.33 - 0.66': 654, 'Tanimoto_index = 0.66 - 1.00': 601, 'Tanimoto_index = 0.00 - 0.33': 321}). 

В то время как в тестовой выборке такой проблемы не наблюдается, наиболее схожи лишь 601/1576 (~40%).

## 3. Подбор и анализ дескрипторов. Построение моделей. ##
Для начала построение моделей на основе классических методов машинного обучения провели с использованием дескрипторов ECFP3 (FP Моргана с радиусом 3).
Таблица с метриками, полученными в ходе различных алгоритмов с подобранными параметрами приведена ниже:


| Алгоритм\Метрики | ROC_AUC | BAC| ACC | F1 | Recall | Precision |
| --------------------|:-------:| -----:|-----:|-----:|-----:|-----:|
| LR | 0.80 | 0.72 | 0.72 | 0.71 | 0.68 | 0.74 |
| RF | 0.85 | 0.78 | 0.78 | 0.76 | 0.73 | 0.79 |
| XGBoost | 0.73 | 0.64 | 0.65 | 0.53 | 0.41 | 0.74 |
| CatBoost | 0.85 | 0.77 | 0.77 | 0.75 | 0.72 | 0.78 |
| SVM | 0.80 | 0.72 | 0.72 | 0.70 | 0.70 | 0.70 |
| Consensus (RF+CatBoost)| 0.85 | 0.77 | 0.78 | 0.76 | 0.73 | 0.78 |

Валидационный сет был составлен ранее на основе быза данных hERG-central.

На графике синим цветом изображена тестовая выборка, зеленым: валидационная. 
![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/ROC_AUC_4.JPG)

Результативность в виде целевой метрики ROC_AUC резко падает при переходе от тествого набора к валидационным. Далее была проведена проверка валидационного сета на схожесть с обучающей выборкой. Оказалось, что только одно соединение прересекалось в выборках. Оно не являлось стандартом при постановке тестов in vitro на кардиотоксичность, но относилось к классу активных. Большинство соединений лежали в диапазоне 0.00-0.33, т.е. были максимально не похожи на обучающую выборку. Данных ChEMBL не хватает для построения модели, которая могла бы эффективно работать c внешними данными.

## 3.2. Поиск корреляции целевого значения со структурными, физико-химическими дескрпторами, наличием отдельных фрагментов и с рядом дескрипторов, вычисленных программой Shroedinger. ##
Чтобы оценить, какие параметры могут коррелировать с целевым значением (pIC50) была построена карта корреляции. Метод корреляци по Пирсону. 
![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/sns_correlation_annot.JPG)

У следующих десркипторов был отмечен коэффициент корреляции по Пирсону > 0.1:
NHOHCount           -0.135866
NOCount             -0.195831
NumHAcceptors       -0.156287
NumHDonors          -0.142673
NumHeteroatoms      -0.182240
NumRotatableBonds    0.119367
fr_amide            -0.137049
LogP                 0.269803
TPSA                -0.232164

Поскольку корреляции были слабыми, дополнительно рассчитали все топологические десркипторы, которые предоставляет ПО Schroedinger. Объединили с предыдущими, а далее с помощью метода Feature importance с permutation (sklearn) рассчитали дескрипторы с наибольшим Mean accuracy decrease. 

![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/feature_permutation.JPG)

Наиболее важными параметрами с Mean accuracy decrease > 0.005 оказались следующие:

"LogP", "MR", "#amine", "CNS", 'dipole', 'ACxDN^.5/SA', 'glob', 'QPlogPo/w'
Описание согласно мануалу:
  - LogP - (от физико-химических: аналогично QPlogPo/w ниже)
  - MR - (от физико-химических: молекулярный вес)
  - #amine - Number of non-conjugated amine groups
  - CNS - Predicted central nervous system activity
  - dipole - Computed dipole moment of the molecule
  - ACxDN^.5/SA - Index of cohesive interaction in solids
  - glob - Globularity descriptor
  - QPlogPo/w - Predicted octanol/water partition coefficient

Модель, построенная исключительно на данных дескрипторах склонна к переобучению даже на выборке с теми соединениями, которые ей однозначно знакомы:

![Image alt](https://github.com/ElinaSmall/hERg_model/raw/main/images/schroed_roc_auc.JPG)
